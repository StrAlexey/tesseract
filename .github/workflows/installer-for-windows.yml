# .github/workflows/installer-for-windows.yml
#
# Builds Tesseract (win64) on Windows runner and packages it into an Inno Setup installer.
# - Uses vcpkg in-repo (no paths outside repo)
# - Copies offline traineddata from repo: assets/tessdata/eng.traineddata
# - Installs to D:\Tesseract-OCR (no admin) and adds install dir to USER PATH
#
# Repo must contain: assets/tessdata/eng.traineddata

name: Cross build for Windows

on:
  workflow_dispatch:

jobs:
  build_and_package_win64:
    runs-on: windows-latest

    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_DEFAULT_TRIPLET: x64-windows
      INSTALL_DIR: D:\Tesseract-OCR

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Validate offline traineddata exists in repo
        shell: pwsh
        run: |
          $td = Join-Path $env:GITHUB_WORKSPACE "assets\tessdata\eng.traineddata"
          if (!(Test-Path $td)) {
            throw "Missing required file: $td. Commit assets/tessdata/eng.traineddata (do not download in CI)."
          }
          Get-Item $td | Format-List

      # -----------------------------
      # vcpkg (in-repo, not outside)
      # -----------------------------
      - name: Clone vcpkg into repo workspace (if not already present)
        shell: pwsh
        run: |
          if (!(Test-Path $env:VCPKG_ROOT)) {
            git clone --depth 1 https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          } else {
            Write-Host "vcpkg already exists at $env:VCPKG_ROOT"
          }

          $marker = Join-Path $env:VCPKG_ROOT ".vcpkg-root"
          if (!(Test-Path $marker)) {
            throw "vcpkg root marker not found: $marker. The cloned vcpkg folder is not a valid classic vcpkg instance."
          }

      - name: Bootstrap vcpkg
        shell: pwsh
        run: |
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics

      - name: Install build tools
        shell: pwsh
        run: |
          choco install -y cmake ninja innosetup
          & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath

      # ----------------------------------------
      # Install deps via vcpkg
      # ----------------------------------------
      - name: Install Tesseract dependencies (vcpkg)
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          & "$env:VCPKG_ROOT\vcpkg.exe" `
            --vcpkg-root "$env:VCPKG_ROOT" `
            --classic `
            install "leptonica:$env:VCPKG_DEFAULT_TRIPLET" "pkgconf:$env:VCPKG_DEFAULT_TRIPLET"

      # -----------------------------
      # Configure & build Tesseract
      # -----------------------------
      - name: Configure Tesseract (CMake)
        shell: pwsh
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build-win64"
          New-Item -ItemType Directory -Force -Path $buildDir | Out-Null

          $toolchain = Join-Path $env:VCPKG_ROOT "scripts\buildsystems\vcpkg.cmake"

          $triplet = $env:VCPKG_DEFAULT_TRIPLET
          $pkgconfExe = Join-Path $env:VCPKG_ROOT "installed\$triplet\tools\pkgconf\pkgconf.exe"
          if (!(Test-Path $pkgconfExe)) {
            throw "pkgconf.exe not found where expected: $pkgconfExe"
          }

          $leptonicaDir = Join-Path $env:VCPKG_ROOT "installed\$triplet\share\leptonica"
          if (!(Test-Path $leptonicaDir)) {
            throw "Leptonica CMake package dir not found: $leptonicaDir"
          }

          $env:PATH = (Split-Path $pkgconfExe -Parent) + ";" + $env:PATH

          cmake -S . -B $buildDir -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DVCPKG_TARGET_TRIPLET="$triplet" `
            -DPKG_CONFIG_EXECUTABLE="$pkgconfExe" `
            -DLeptonica_DIR="$leptonicaDir" `
            -DSW_BUILD=OFF `
            -DBUILD_TESTS=OFF `
            -DBUILD_TRAINING_TOOLS=OFF `
            -DBUILD_SHARED_LIBS=ON

      - name: Build target tesseract (x64 Release)
        shell: pwsh
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build-win64"
          cmake --build $buildDir --config Release --target tesseract

      # -----------------------------
      # Assemble runtime folder
      # -----------------------------
      - name: Assemble runtime folder (dist_runtime)
        shell: pwsh
        run: |
          $buildDir   = Join-Path $env:GITHUB_WORKSPACE "build-win64"
          $runtimeDir = Join-Path $env:GITHUB_WORKSPACE "dist_runtime"
          $tessdata   = Join-Path $runtimeDir "tessdata"

          Remove-Item -Recurse -Force $runtimeDir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $runtimeDir | Out-Null
          New-Item -ItemType Directory -Force -Path $tessdata   | Out-Null

          $exe = Get-ChildItem -Path $buildDir -Recurse -Filter "tesseract.exe" -File -ErrorAction SilentlyContinue |
            Where-Object { $_.FullName -notmatch '\\CMakeFiles\\' } |
            Select-Object -First 1

          if (-not $exe) {
            Write-Host "Listing build directory for debugging:"
            Get-ChildItem -Recurse -File $buildDir | Select-Object FullName | Out-Host
            throw "tesseract.exe not produced (could not find anywhere under $buildDir)."
          }

          Write-Host "Using tesseract.exe: $($exe.FullName)"
          Copy-Item $exe.FullName $runtimeDir -Force

          Get-ChildItem -Path $buildDir -Recurse -Filter *.dll -File |
            Where-Object { $_.FullName -notmatch '\\CMakeFiles\\' } |
            ForEach-Object {
              Copy-Item $_.FullName $runtimeDir -Force -ErrorAction SilentlyContinue
            }

          $vcpkgBin = Join-Path $env:VCPKG_ROOT "installed\$env:VCPKG_DEFAULT_TRIPLET\bin"
          if (Test-Path $vcpkgBin) {
            Get-ChildItem -Path $vcpkgBin -Filter *.dll -File |
              ForEach-Object {
                Copy-Item $_.FullName $runtimeDir -Force -ErrorAction SilentlyContinue
              }
          }

          $repoTessdata = Join-Path $env:GITHUB_WORKSPACE "tessdata"
          if (Test-Path $repoTessdata) {
            Copy-Item (Join-Path $repoTessdata "*") $tessdata -Recurse -Force -ErrorAction SilentlyContinue
          }

          Copy-Item (Join-Path $env:GITHUB_WORKSPACE "assets\tessdata\eng.traineddata") $tessdata -Force

          Write-Host "dist_runtime:"
          Get-ChildItem -Path $runtimeDir -Force | Format-Table Name, Length
          Write-Host "dist_runtime\tessdata:"
          Get-ChildItem -Path $tessdata -Force | Format-Table Name, Length

      - name: Upload runtime artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-runtime-win64
          path: dist_runtime

      # -----------------------------
      # Create Inno Setup installer
      # -----------------------------
      - name: Create Inno Setup script
        shell: pwsh
        run: |
          $packagingDir = Join-Path $env:GITHUB_WORKSPACE "packaging"
          New-Item -ItemType Directory -Force -Path $packagingDir | Out-Null

          $dateTag = (Get-Date).ToString("yyyyMMdd-HHmm")
          $issPath = Join-Path $packagingDir "tesseract.iss"

          @"
          ; Auto-generated by GitHub Actions
          #define AppName "Tesseract-OCR"
          #define AppVersion "$dateTag"
          #define InstallDir "$($env:INSTALL_DIR)"

          [Setup]
          AppId={{A55E3C41-79F5-4D35-9E52-0D6B1F3B0E3D}
          AppName={#AppName}
          AppVersion={#AppVersion}

          DefaultDirName={#InstallDir}
          DisableDirPage=yes
          DisableProgramGroupPage=yes

          PrivilegesRequired=lowest
          ChangesEnvironment=yes

          OutputDir=output
          OutputBaseFilename=tesseract-ocr-installer-{#AppVersion}-win64
          Compression=lzma2
          SolidCompression=yes
          WizardStyle=modern
          UninstallDisplayIcon={app}\tesseract.exe

          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Files]
          Source: "{#SourcePath}\..\dist_runtime\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs ignoreversion

          [Registry]
          Root: HKCU; Subkey: "Software\Tesseract-OCR"; ValueType: string; ValueName: "Path"; ValueData: "{app}"; Flags: uninsdeletekey

          [Code]
          function NormalizePath(const S: string): string;
          begin
            Result := Trim(S);
            while (Length(Result) > 0) and ((Result[Length(Result)] = '\') or (Result[Length(Result)] = ' ')) do
              Delete(Result, Length(Result), 1);
          end;

          function PathContains(const Paths, NewPath: string): Boolean;
          var
            P, N: string;
          begin
            P := ';' + LowerCase(Paths) + ';';
            N := ';' + LowerCase(NormalizePath(NewPath)) + ';';
            Result := Pos(N, P) > 0;
          end;

          procedure AddToUserPath(const NewPath: string);
          var
            Paths: string;
            NP: string;
          begin
            NP := NormalizePath(NewPath);

            if RegQueryStringValue(HKCU, 'Environment', 'Path', Paths) then
            begin
              if not PathContains(Paths, NP) then
              begin
                if (Paths <> '') and (Paths[Length(Paths)] <> ';') then
                  Paths := Paths + ';';
                Paths := Paths + NP;
                RegWriteStringValue(HKCU, 'Environment', 'Path', Paths);
              end;
            end
            else
            begin
              RegWriteStringValue(HKCU, 'Environment', 'Path', NP);
            end;
          end;

          function RemoveOnePath(const Paths, RemovePath: string): string;
          var
            P, R: string;
            I: Integer;
            Part: string;
          begin
            Result := '';
            R := LowerCase(NormalizePath(RemovePath));
            P := Paths;

            while P <> '' do
            begin
              I := Pos(';', P);
              if I = 0 then
              begin
                Part := P;
                P := '';
              end
              else
              begin
                Part := Copy(P, 1, I - 1);
                Delete(P, 1, I);
              end;

              Part := Trim(Part);
              if (Part <> '') and (LowerCase(NormalizePath(Part)) <> R) then
              begin
                if Result = '' then
                  Result := Part
                else
                  Result := Result + ';' + Part;
              end;
            end;
          end;

          procedure RemoveFromUserPath(const RemovePath: string);
          var
            Paths: string;
            NewPaths: string;
          begin
            if RegQueryStringValue(HKCU, 'Environment', 'Path', Paths) then
            begin
              NewPaths := RemoveOnePath(Paths, RemovePath);
              RegWriteStringValue(HKCU, 'Environment', 'Path', NewPaths);
            end;
          end;

          procedure CurStepChanged(CurStep: TSetupStep);
          begin
            if CurStep = ssPostInstall then
              AddToUserPath(ExpandConstant('{app}'));
          end;

          procedure CurUninstallStepChanged(CurUninstallStep: TUninstallStep);
          begin
            if CurUninstallStep = usPostUninstall then
              RemoveFromUserPath(ExpandConstant('{app}'));
          end;
          "@ | Set-Content -Encoding UTF8 $issPath

          Write-Host "Created: $issPath"
          Get-Content $issPath | Select-Object -First 120 | Out-Host

      - name: Build installer (Inno Setup)
        shell: pwsh
        run: |
          iscc "packaging\tesseract.iss"
          # FIX: output folder is relative to the .iss location => packaging\output
          dir "packaging\output"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: Tesseract Installer (Inno Setup, D drive)
          # FIX: installer is in packaging\output
          path: packaging\output\*.exe
