# GitHub actions - Build Tesseract runtime (win64) and package it into a silent-friendly installer (Inno Setup)

name: Tesseract Installer for Windows (Inno Setup, D drive)

on:
  workflow_dispatch:

jobs:
  build_runtime_win64:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      # 1) Run the existing build script as-is (DO NOT MODIFY build.sh)
      - name: Build Tesseract (existing script)
        run: |
          set -e
          chmod +x nsis/build.sh
          nsis/build.sh x86_64

      # 2) Assemble a runtime folder from the produced ./mingw64 output
      # build.sh uses: MINGW=/mingw64 -> MINGW_INSTALL=${PWD}${MINGW} => ./mingw64
      - name: Assemble runtime folder (dist_runtime)
        run: |
          set -euo pipefail

          RUNTIME_DIR="dist_runtime"
          MINGW_INSTALL_DIR="${PWD}/mingw64"

          if [ ! -d "$MINGW_INSTALL_DIR" ]; then
            echo "Expected folder not found: $MINGW_INSTALL_DIR"
            exit 1
          fi

          rm -rf "$RUNTIME_DIR"
          mkdir -p "$RUNTIME_DIR"
          mkdir -p "$RUNTIME_DIR/tessdata"

          # Main executable
          cp -v "$MINGW_INSTALL_DIR/bin/tesseract.exe" "$RUNTIME_DIR/"

          # Copy DLLs (broad copy is OK for a runtime bundle)
          cp -v "$MINGW_INSTALL_DIR/bin/"*.dll "$RUNTIME_DIR/" || true
          if [ -d "${PWD}/dll" ]; then
            cp -Lv "${PWD}/dll/"*.dll "$RUNTIME_DIR/" || true
          fi

          # tessdata support files (configs, tessconfigs, pdf.ttf, etc.)
          if [ -d "$MINGW_INSTALL_DIR/share/tessdata" ]; then
            cp -R "$MINGW_INSTALL_DIR/share/tessdata/"* "$RUNTIME_DIR/tessdata/" || true
          fi

          # Use ONLY custom English traineddata from repository (offline, no downloads)
          rm -f "$RUNTIME_DIR/tessdata/"*.traineddata || true

          if [ ! -f "assets/tessdata/eng.traineddata" ]; then
            echo "Missing assets/tessdata/eng.traineddata in repository."
            echo "Add it to the repo and commit it, then re-run workflow."
            exit 1
          fi

          cp -v "assets/tessdata/eng.traineddata" "$RUNTIME_DIR/tessdata/eng.traineddata"

          echo "Runtime folder content:"
          ls -la "$RUNTIME_DIR"
          echo "tessdata content:"
          ls -la "$RUNTIME_DIR/tessdata"

      - name: Upload runtime artifact
        uses: actions/upload-artifact@v6
        with:
          name: tesseract-runtime-win64
          path: dist_runtime

      # Optional: also upload the original NSIS installer produced by build.sh (for reference)
      - name: Upload original NSIS installer (optional)
        uses: actions/upload-artifact@v6
        with:
          name: original-nsis-installer
          path: dist

  package_inno_installer:
    runs-on: windows-latest
    needs: build_runtime_win64
    steps:
      - uses: actions/checkout@v6

      - name: Download runtime artifact
        uses: actions/download-artifact@v6
        with:
          name: tesseract-runtime-win64
          path: dist_runtime

      # Install Inno Setup compiler
      - name: Install Inno Setup
        shell: powershell
        run: |
          choco install innosetup -y

      # Generate an .iss file on the fly (so you don't need to commit it)
      - name: Create Inno Setup script
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "packaging" | Out-Null

          $dateTag = (Get-Date).ToString("yyyyMMdd-HHmm")

          @"
; Auto-generated by GitHub Actions
#define AppName "Tesseract-OCR"
#define AppVersion "$dateTag"
#define InstallDir "D:\Tesseract-OCR"

[Setup]
AppId={{A55E3C41-79F5-4D35-9E52-0D6B1F3B0E3D}
AppName={#AppName}
AppVersion={#AppVersion}
DefaultDirName={#InstallDir}
DisableDirPage=yes
DisableProgramGroupPage=yes

; No admin (installing to D: is typically allowed for normal users)
PrivilegesRequired=lowest

OutputDir=output
OutputBaseFilename=tesseract-ocr-installer-{#AppVersion}-win64
Compression=lzma2
SolidCompression=yes
WizardStyle=modern
UninstallDisplayIcon={app}\tesseract.exe

[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"

[Files]
; Copy the prepared runtime folder into D:\Tesseract-OCR
Source: "{#SourcePath}\..\dist_runtime\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs ignoreversion

[Registry]
; Store install path for easy discovery (per-user, no admin needed)
Root: HKCU; Subkey: "Software\Tesseract-OCR"; ValueType: string; ValueName: "Path"; ValueData: "{app}"; Flags: uninsdeletekey
"@ | Set-Content -Encoding UTF8 "packaging\tesseract.iss"

      - name: Build installer (Inno Setup)
        shell: powershell
        run: |
          iscc "packaging\tesseract.iss"
          dir output

      - name: Upload Inno Setup installer
        uses: actions/upload-artifact@v6
        with:
          name: Tesseract Installer (Inno Setup, D drive)
          path: output\*.exe
