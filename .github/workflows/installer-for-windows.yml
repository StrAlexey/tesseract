name: Cross build for Windows

on:
  workflow_dispatch:

jobs:
  build_and_package_win64:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate offline traineddata exists in repo
        shell: powershell
        run: |
          $trainedDataPath = Join-Path $env:GITHUB_WORKSPACE "assets\tessdata\eng.traineddata"
          if (-not (Test-Path $trainedDataPath)) {
            Write-Host "Missing file: $trainedDataPath"
            exit 1
          }
          Write-Host "OK: Found $trainedDataPath"

      - name: Install build tools
        shell: powershell
        run: |
          choco install innosetup -y
          choco install ninja -y

      # ---- vcpkg (manual, no lukka/run-vcpkg) ----
      - name: Clone and bootstrap vcpkg
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $vcpkgRoot = Join-Path $env:RUNNER_TEMP "vcpkg"
          if (Test-Path $vcpkgRoot) { Remove-Item $vcpkgRoot -Recurse -Force }

          git clone https://github.com/microsoft/vcpkg $vcpkgRoot
          & "$vcpkgRoot\bootstrap-vcpkg.bat" -disableMetrics

          "VCPKG_ROOT=$vcpkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "VCPKG_ROOT=$vcpkgRoot"

      - name: Install dependencies via vcpkg (x64-windows)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $vcpkg = Join-Path $env:VCPKG_ROOT "vcpkg.exe"

          # Wider set to avoid "missing <...>" surprises on Windows builds.
          # leptonica pulls image libs; icu/libarchive are common optional deps.
          & $vcpkg install leptonica:x64-windows icu:x64-windows libarchive:x64-windows

      # ---- Build Tesseract from THIS repo using vcpkg toolchain ----
      - name: Configure Tesseract (CMake)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $sourceRoot = $env:GITHUB_WORKSPACE
          $buildRoot = Join-Path $sourceRoot "build-win64"

          if (Test-Path $buildRoot) { Remove-Item $buildRoot -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $buildRoot | Out-Null

          $toolchain = Join-Path $env:VCPKG_ROOT "scripts\buildsystems\vcpkg.cmake"

          cmake -S $sourceRoot -B $buildRoot -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DVCPKG_TARGET_TRIPLET="x64-windows" `
            -DBUILD_TRAINING_TOOLS=OFF `
            -DBUILD_SHARED_LIBS=ON `
            -DBUILD_TESTS=OFF `
            -DBUILD_TESSERACT=ON `
            -DCMAKE_INSTALL_PREFIX="$($buildRoot)\_install"

      - name: Build target tesseract (x64 Release)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $sourceRoot = $env:GITHUB_WORKSPACE
          $buildRoot = Join-Path $sourceRoot "build-win64"

          try {
            cmake --build $buildRoot --config Release --target tesseract --verbose
          }
          catch {
            Write-Host "Build failed. Dumping Ninja log if present..."
            $ninjaLog = Join-Path $buildRoot ".ninja_log"
            if (Test-Path $ninjaLog) {
              Write-Host "---- .ninja_log (tail) ----"
              Get-Content $ninjaLog -Tail 200 | Out-Host
            }
            throw
          }

      - name: Install build outputs (cmake --install)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $sourceRoot = $env:GITHUB_WORKSPACE
          $buildRoot = Join-Path $sourceRoot "build-win64"

          cmake --install $buildRoot --config Release

          $installDir = Join-Path $buildRoot "_install"
          if (-not (Test-Path $installDir)) {
            throw "Install directory not found: $installDir"
          }

          Write-Host "Installed tree (top):"
          Get-ChildItem -Path $installDir | Select-Object Name | Out-Host

      - name: Assemble runtime folder (dist_runtime)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $sourceRoot = $env:GITHUB_WORKSPACE
          $buildRoot = Join-Path $sourceRoot "build-win64"
          $installDir = Join-Path $buildRoot "_install"
          $runtimeRoot = Join-Path $sourceRoot "dist_runtime"

          if (Test-Path $runtimeRoot) { Remove-Item $runtimeRoot -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $runtimeRoot | Out-Null
          New-Item -ItemType Directory -Force -Path (Join-Path $runtimeRoot "tessdata") | Out-Null

          # Find tesseract.exe from installed prefix
          $tesseractExe = Get-ChildItem -Path $installDir -Recurse -Filter "tesseract.exe" -File | Select-Object -First 1
          if (-not $tesseractExe) {
            Write-Host "tesseract.exe not found under install dir. Dumping files..."
            Get-ChildItem -Path $installDir -Recurse -File | Select-Object FullName | Out-Host
            throw "tesseract.exe not produced."
          }

          Copy-Item -Force $tesseractExe.FullName (Join-Path $runtimeRoot "tesseract.exe")

          # Copy DLLs from install tree and vcpkg bin
          $vcpkgBin = Join-Path $env:VCPKG_ROOT "installed\x64-windows\bin"

          $dllDirs = @(
            (Split-Path $tesseractExe.FullName -Parent),
            $vcpkgBin
          ) | Where-Object { Test-Path $_ } | Select-Object -Unique

          foreach ($dir in $dllDirs) {
            Get-ChildItem -Path $dir -Filter "*.dll" -File -ErrorAction SilentlyContinue | ForEach-Object {
              Copy-Item -Force $_.FullName $runtimeRoot
            }
          }

          # Offline traineddata (your file)
          Copy-Item -Force (Join-Path $sourceRoot "assets\tessdata\eng.traineddata") (Join-Path $runtimeRoot "tessdata\eng.traineddata")

          Write-Host "dist_runtime content:"
          Get-ChildItem -Path $runtimeRoot -File | Select-Object Name, Length | Format-Table -AutoSize | Out-Host
          Write-Host "dist_runtime\tessdata content:"
          Get-ChildItem -Path (Join-Path $runtimeRoot "tessdata") -File | Select-Object Name, Length | Format-Table -AutoSize | Out-Host

      # ---- Inno Setup packaging to D:\Tesseract-OCR + PATH ----
      - name: Create Inno Setup script
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $packagingDir = Join-Path $env:GITHUB_WORKSPACE "packaging"
          New-Item -ItemType Directory -Force -Path $packagingDir | Out-Null

          $dateTag = (Get-Date).ToString("yyyyMMdd-HHmm")
          $issPath = Join-Path $packagingDir "tesseract.iss"

          @"
          ; Auto-generated by GitHub Actions
          #define AppName "Tesseract-OCR"
          #define AppVersion "$dateTag"
          #define InstallDir "D:\Tesseract-OCR"

          [Setup]
          AppId={{A55E3C41-79F5-4D35-9E52-0D6B1F3B0E3D}
          AppName={#AppName}
          AppVersion={#AppVersion}
          DefaultDirName={#InstallDir}
          DisableDirPage=yes
          DisableProgramGroupPage=yes

          PrivilegesRequired=lowest

          OutputDir=output
          OutputBaseFilename=tesseract-ocr-installer-{#AppVersion}-win64
          Compression=lzma2
          SolidCompression=yes
          WizardStyle=modern
          UninstallDisplayIcon={app}\tesseract.exe

          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Files]
          Source: "{#SourcePath}\..\dist_runtime\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs ignoreversion

          [Registry]
          Root: HKCU; Subkey: "Software\Tesseract-OCR"; ValueType: string; ValueName: "Path"; ValueData: "{app}"; Flags: uninsdeletekey
          Root: HKCU; Subkey: "Environment"; ValueType: expandsz; ValueName: "TESSDATA_PREFIX"; ValueData: "{app}"; Flags: preservestringtype

          [Code]
          function PathContains(const ExistingPath, Dir: string): Boolean;
          begin
            Result := (Pos(';' + Lowercase(Dir) + ';', ';' + Lowercase(ExistingPath) + ';') > 0);
          end;

          procedure AddToUserPath(const Dir: string);
          var
            ExistingPath: string;
          begin
            if not RegQueryStringValue(HKCU, 'Environment', 'Path', ExistingPath) then
              ExistingPath := '';

            if not PathContains(ExistingPath, Dir) then
            begin
              if (ExistingPath <> '') and (Copy(ExistingPath, Length(ExistingPath), 1) <> ';') then
                ExistingPath := ExistingPath + ';';
              ExistingPath := ExistingPath + Dir;
              RegWriteExpandStringValue(HKCU, 'Environment', 'Path', ExistingPath);
            end;
          end;

          procedure RemoveFromUserPath(const Dir: string);
          var
            ExistingPath: string;
            NormalizedPath: string;
            Needle: string;
            P: Integer;
          begin
            if not RegQueryStringValue(HKCU, 'Environment', 'Path', ExistingPath) then
              exit;

            NormalizedPath := ';' + ExistingPath + ';';
            Needle := ';' + Dir + ';';

            P := Pos(Lowercase(Needle), Lowercase(NormalizedPath));
            while P > 0 do
            begin
              Delete(NormalizedPath, P, Length(Needle) - 1);
              P := Pos(Lowercase(Needle), Lowercase(NormalizedPath));
            end;

            if (Length(NormalizedPath) >= 1) and (Copy(NormalizedPath, 1, 1) = ';') then
              Delete(NormalizedPath, 1, 1);
            if (Length(NormalizedPath) >= 1) and (Copy(NormalizedPath, Length(NormalizedPath), 1) = ';') then
              Delete(NormalizedPath, Length(NormalizedPath), 1);

            RegWriteExpandStringValue(HKCU, 'Environment', 'Path', NormalizedPath);
          end;

          procedure CurStepChanged(CurStep: TSetupStep);
          begin
            if CurStep = ssPostInstall then
              AddToUserPath(ExpandConstant('{app}'));
          end;

          procedure CurUninstallStepChanged(CurUninstallStep: TUninstallStep);
          begin
            if CurUninstallStep = usPostUninstall then
              RemoveFromUserPath(ExpandConstant('{app}'));
          end;
          "@ | Set-Content -Encoding UTF8 $issPath

      - name: Build installer (Inno Setup)
        shell: powershell
        run: |
          iscc "packaging\tesseract.iss"
          dir output

      - name: Upload installer artifact
        uses: actions/upload-artifact@v6
        with:
          name: Tesseract Installer (Inno Setup, D drive)
          path: output\*.exe
