# GitHub actions - Build Tesseract (win64) and package it into a silent-friendly installer (Inno Setup)
# Installs to D:\Tesseract-OCR (no admin) and adds {app} to user PATH.

name: Cross build for Windows

on:
  workflow_dispatch:

jobs:
  build_and_package_win64:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      # --- 0) Validate offline traineddata exists in repo ---
      - name: Validate offline traineddata exists in repo
        shell: powershell
        run: |
          $p = Join-Path $env:GITHUB_WORKSPACE "assets\tessdata\eng.traineddata"
          if (!(Test-Path $p)) {
            Write-Error "Missing required file: $p  (Put eng.traineddata into assets/tessdata/ and commit it)"
            exit 1
          }
          Write-Host "OK: found $p"

      # --- 1) Setup MSVC environment (so CMake uses cl.exe, not mingw) ---
      - name: Setup MSVC Dev Cmd
        uses: ilammy/msvc-dev-cmd@v1

      # --- 2) Setup vcpkg inside the repository workspace (fixes 'outside repository' issue) ---
      - name: Setup vcpkg and install dependencies
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}\vcpkg
          # Use the repo's vcpkg.json if present; otherwise you can switch to "runVcpkgInstall: true" with explicit packages.
          runVcpkgInstall: true

      # --- 3) Configure Tesseract (IMPORTANT: SW_BUILD=OFF to avoid find_package(SW REQUIRED)) ---
      - name: Configure Tesseract (CMake, Release)
        shell: powershell
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build-win64"
          New-Item -ItemType Directory -Force -Path $buildDir | Out-Null

          $toolchain = Join-Path $env:GITHUB_WORKSPACE "vcpkg\scripts\buildsystems\vcpkg.cmake"
          if (!(Test-Path $toolchain)) {
            Write-Error "vcpkg toolchain not found: $toolchain"
            exit 1
          }

          cmake -S . -B $buildDir -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DSW_BUILD=OFF `
            -DOPENMP_BUILD=OFF `
            -DBUILD_TESTS=OFF `
            -DBUILD_TRAINING_TOOLS=OFF `
            -DINSTALL_CONFIGS=ON

      # --- 4) Build ---
      - name: Build Tesseract (Release)
        shell: powershell
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build-win64"
          cmake --build $buildDir --config Release

      # --- 5) Install into a staging directory ---
      - name: Install to staging
        shell: powershell
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build-win64"
          $stageDir = Join-Path $env:GITHUB_WORKSPACE "dist_runtime"
          if (Test-Path $stageDir) { Remove-Item -Recurse -Force $stageDir }
          New-Item -ItemType Directory -Force -Path $stageDir | Out-Null

          cmake --install $buildDir --prefix $stageDir

          Write-Host "Staging content:"
          Get-ChildItem -Recurse $stageDir | Select-Object FullName | Format-Table -AutoSize

      # --- 6) Normalize runtime layout to a simple portable folder (tesseract.exe + dll + tessdata) ---
      - name: Assemble runtime folder (runtime_out)
        shell: powershell
        run: |
          $stageDir = Join-Path $env:GITHUB_WORKSPACE "dist_runtime"
          $outDir   = Join-Path $env:GITHUB_WORKSPACE "runtime_out"

          if (Test-Path $outDir) { Remove-Item -Recurse -Force $outDir }
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          New-Item -ItemType Directory -Force -Path (Join-Path $outDir "tessdata") | Out-Null

          # Common install layouts:
          # - MSVC install usually puts binaries into: dist_runtime\bin
          # - data often into: dist_runtime\share\tessdata
          $binDir = Join-Path $stageDir "bin"
          if (!(Test-Path $binDir)) {
            Write-Error "Expected bin dir not found: $binDir"
            exit 1
          }

          # Copy exe + dlls
          Copy-Item (Join-Path $binDir "tesseract.exe") $outDir -Force
          Get-ChildItem $binDir -Filter "*.dll" | ForEach-Object {
            Copy-Item $_.FullName $outDir -Force
          }

          # Copy tessdata support files if they exist
          $tessdataSrc = Join-Path $stageDir "share\tessdata"
          if (Test-Path $tessdataSrc) {
            Copy-Item (Join-Path $tessdataSrc "*") (Join-Path $outDir "tessdata") -Recurse -Force
          }

          # Remove any traineddata that might have been installed by build scripts
          Get-ChildItem (Join-Path $outDir "tessdata") -Filter "*.traineddata" -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue

          # Copy YOUR offline traineddata (eng only)
          $eng = Join-Path $env:GITHUB_WORKSPACE "assets\tessdata\eng.traineddata"
          Copy-Item $eng (Join-Path $outDir "tessdata\eng.traineddata") -Force

          Write-Host "runtime_out:"
          Get-ChildItem -Recurse $outDir | Select-Object FullName | Format-Table -AutoSize

      - name: Upload runtime artifact (optional)
        uses: actions/upload-artifact@v6
        with:
          name: tesseract-runtime-win64
          path: runtime_out

      # --- 7) Install Inno Setup compiler ---
      - name: Install Inno Setup
        shell: powershell
        run: |
          choco install innosetup -y

      # --- 8) Create Inno Setup script (.iss) ---
      - name: Create Inno Setup script
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "packaging" | Out-Null
          New-Item -ItemType Directory -Force -Path "output" | Out-Null

          $dateTag = (Get-Date).ToString("yyyyMMdd-HHmm")
          $iss = @"
; Auto-generated by GitHub Actions
#define AppName "Tesseract-OCR"
#define AppVersion "$dateTag"
#define InstallDir "D:\Tesseract-OCR"

[Setup]
AppId={{A55E3C41-79F5-4D35-9E52-0D6B1F3B0E3D}
AppName={#AppName}
AppVersion={#AppVersion}
DefaultDirName={#InstallDir}
DisableDirPage=yes
DisableProgramGroupPage=yes
PrivilegesRequired=lowest
OutputDir=output
OutputBaseFilename=tesseract-ocr-installer-{#AppVersion}-win64
Compression=lzma2
SolidCompression=yes
WizardStyle=modern
UninstallDisplayIcon={app}\tesseract.exe
ChangesEnvironment=yes

[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"

[Files]
Source: "{#SourcePath}\..\runtime_out\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs ignoreversion

[Registry]
; Store install path for discovery (per-user)
Root: HKCU; Subkey: "Software\Tesseract-OCR"; ValueType: string; ValueName: "Path"; ValueData: "{app}"; Flags: uninsdeletekey

[Code]
function PathContains(const PathValue, Dir: string): Boolean;
begin
  Result := (Pos(';' + Lowercase(Dir) + ';', ';' + Lowercase(PathValue) + ';') > 0);
end;

function RemoveFromPath(const PathValue, Dir: string): string;
var
  S: string;
begin
  S := StringChangeEx(';' + PathValue + ';', ';' + Dir + ';', ';', True);
  if (Length(S) >= 2) and (S[1] = ';') and (S[Length(S)] = ';') then
    S := Copy(S, 2, Length(S) - 2);
  Result := S;
end;

procedure AddAppToUserPath();
var
  PathValue: string;
begin
  if not RegQueryStringValue(HKCU, 'Environment', 'Path', PathValue) then
    PathValue := '';

  if not PathContains(PathValue, ExpandConstant('{app}')) then
  begin
    if (PathValue <> '') and (PathValue[Length(PathValue)] <> ';') then
      PathValue := PathValue + ';';
    PathValue := PathValue + ExpandConstant('{app}');
    RegWriteExpandStringValue(HKCU, 'Environment', 'Path', PathValue);
  end;
end;

procedure RemoveAppFromUserPath();
var
  PathValue: string;
begin
  if RegQueryStringValue(HKCU, 'Environment', 'Path', PathValue) then
  begin
    if PathContains(PathValue, ExpandConstant('{app}')) then
    begin
      PathValue := RemoveFromPath(PathValue, ExpandConstant('{app}'));
      RegWriteExpandStringValue(HKCU, 'Environment', 'Path', PathValue);
    end;
  end;
end;

procedure CurStepChanged(CurStep: TSetupStep);
begin
  if CurStep = ssPostInstall then
  begin
    AddAppToUserPath();
  end;
end;

procedure CurUninstallStepChanged(CurUninstallStep: TUninstallStep);
begin
  if CurUninstallStep = usPostUninstall then
  begin
    RemoveAppFromUserPath();
  end;
end;
"@

          $iss | Set-Content -Encoding UTF8 "packaging\tesseract.iss"
          Write-Host "Generated packaging\tesseract.iss"

      # --- 9) Build installer ---
      - name: Build installer (Inno Setup)
        shell: powershell
        run: |
          iscc "packaging\tesseract.iss"
          dir output

      # --- 10) Upload installer artifact ---
      - name: Upload installer artifact
        uses: actions/upload-artifact@v6
        with:
          name: Tesseract Installer (Inno Setup, D drive)
          path: output\*.exe
