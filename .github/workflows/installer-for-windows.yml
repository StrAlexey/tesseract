name: Cross build for Windows

on:
  workflow_dispatch:

jobs:
  build_and_package_win64:
    runs-on: windows-latest

    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_DEFAULT_TRIPLET: x64-windows
      INSTALL_DIR: D:\Tesseract-OCR

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Validate traineddata
        shell: pwsh
        run: |
          if (!(Test-Path "assets\tessdata\eng.traineddata")) {
            throw "assets/tessdata/eng.traineddata missing"
          }

      - name: Clone vcpkg
        shell: pwsh
        run: |
          if (!(Test-Path vcpkg)) {
            git clone https://github.com/microsoft/vcpkg vcpkg
          }

      - name: Bootstrap vcpkg
        shell: pwsh
        run: |
          vcpkg\bootstrap-vcpkg.bat -disableMetrics

      - name: Install build tools
        shell: pwsh
        run: |
          choco install -y cmake ninja innosetup

      - name: Setup MSVC Dev Cmd
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install deps (vcpkg)
        shell: pwsh
        run: |
          vcpkg\vcpkg.exe --classic install leptonica:x64-windows

      - name: Configure
        shell: pwsh
        run: |
          $buildDir = "build-win64"
          $toolchain = "$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"
          $ninja = "C:\ProgramData\chocolatey\bin\ninja.exe"

          if (!(Test-Path $ninja)) { throw "Ninja not found" }
          if (!(Test-Path $toolchain)) { throw "vcpkg toolchain not found" }

          cmake -S . -B $buildDir -G Ninja `
            -DCMAKE_MAKE_PROGRAM="$ninja" `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DCMAKE_BUILD_TYPE=Release `
            -DSW_BUILD=OFF `
            -DUSE_PKGCONFIG=OFF `
            -DBUILD_TESTS=OFF `
            -DBUILD_TRAINING_TOOLS=OFF

      - name: Build
        shell: pwsh
        run: |
          cmake --build build-win64 --target tesseract

      - name: Assemble runtime
        shell: pwsh
        run: |
          Remove-Item dist_runtime -Recurse -Force -ErrorAction SilentlyContinue
          New-Item dist_runtime\tessdata -ItemType Directory | Out-Null

          $exe = Get-ChildItem build-win64 -Recurse -Filter tesseract.exe | Select-Object -First 1
          if (-not $exe) { throw "tesseract.exe not found" }

          Copy-Item $exe.FullName dist_runtime
          Copy-Item assets\tessdata\eng.traineddata dist_runtime\tessdata

      - name: Build installer
        shell: pwsh
        run: |
          iscc packaging\tesseract.iss

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: Tesseract Installer
          path: packaging\output\*.exe
