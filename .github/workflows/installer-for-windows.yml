name: Cross build for Windows

on:
  workflow_dispatch:

jobs:
  build_and_package_win64:
    runs-on: windows-latest

    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_DEFAULT_TRIPLET: x64-windows
      INSTALL_DIR: D:\Tesseract-OCR

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Validate traineddata
        shell: pwsh
        run: |
          if (!(Test-Path "assets\tessdata\eng.traineddata")) {
            throw "assets/tessdata/eng.traineddata missing"
          }

      - name: Clone vcpkg
        shell: pwsh
        run: |
          if (!(Test-Path vcpkg)) {
            git clone https://github.com/microsoft/vcpkg vcpkg
          }

      - name: Bootstrap vcpkg
        shell: pwsh
        run: |
          vcpkg\bootstrap-vcpkg.bat -disableMetrics

      - name: Install deps
        shell: pwsh
        run: |
          vcpkg\vcpkg.exe --classic install leptonica:x64-windows

      - name: Configure
        shell: pwsh
        run: |
          cmake -S . -B build-win64 -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE=vcpkg\scripts\buildsystems\vcpkg.cmake `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DSW_BUILD=OFF `
            -DBUILD_TESTS=OFF `
            -DBUILD_TRAINING_TOOLS=OFF

      - name: Build
        shell: pwsh
        run: |
          cmake --build build-win64 --target tesseract

      - name: Assemble runtime
        shell: pwsh
        run: |
          Remove-Item dist_runtime -Recurse -Force -ErrorAction SilentlyContinue
          New-Item dist_runtime\tessdata -ItemType Directory | Out-Null

          $exe = Get-ChildItem build-win64 -Recurse -Filter tesseract.exe | Select-Object -First 1
          if (-not $exe) { throw "tesseract.exe not found" }

          Copy-Item $exe.FullName dist_runtime
          Copy-Item assets\tessdata\eng.traineddata dist_runtime\tessdata

      - name: Build installer
        shell: pwsh
        run: |
          iscc packaging\tesseract.iss

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: Tesseract Installer
          path: packaging\output\*.exe
