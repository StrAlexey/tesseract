# .github/workflows/installer-for-windows.yml

name: Cross build for Windows

on:
  workflow_dispatch:

jobs:
  build_and_package_win64:
    runs-on: windows-latest

    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_DEFAULT_TRIPLET: x64-windows
      INSTALL_DIR: D:\Tesseract-OCR

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Validate offline traineddata exists in repo
        shell: pwsh
        run: |
          $td = Join-Path $env:GITHUB_WORKSPACE "assets\tessdata\eng.traineddata"
          if (!(Test-Path $td)) {
            throw "Missing required file: $td"
          }

      - name: Clone vcpkg
        shell: pwsh
        run: |
          if (!(Test-Path $env:VCPKG_ROOT)) {
            git clone --depth 1 https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          }

      - name: Bootstrap vcpkg
        shell: pwsh
        run: |
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics

      - name: Install build tools
        shell: pwsh
        run: |
          choco install -y cmake ninja innosetup

      - name: Install Tesseract dependencies
        shell: pwsh
        run: |
          & "$env:VCPKG_ROOT\vcpkg.exe" --classic install leptonica:$env:VCPKG_DEFAULT_TRIPLET

      - name: Configure Tesseract
        shell: pwsh
        run: |
          cmake -S . -B build-win64 -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET="$env:VCPKG_DEFAULT_TRIPLET" `
            -DSW_BUILD=OFF `
            -DBUILD_TESTS=OFF `
            -DBUILD_TRAINING_TOOLS=OFF `
            -DBUILD_SHARED_LIBS=ON

      - name: Build Tesseract
        shell: pwsh
        run: |
          cmake --build build-win64 --target tesseract

      - name: Assemble runtime folder
        shell: pwsh
        run: |
          $runtime = "dist_runtime"
          Remove-Item $runtime -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force $runtime\tessdata | Out-Null

          $exe = Get-ChildItem build-win64 -Recurse -Filter tesseract.exe | Select-Object -First 1
          if (-not $exe) { throw "tesseract.exe not found" }
          Copy-Item $exe.FullName $runtime

          Get-ChildItem build-win64 -Recurse -Filter *.dll | Copy-Item -Destination $runtime -Force -ErrorAction SilentlyContinue
          Get-ChildItem "$env:VCPKG_ROOT\installed\$env:VCPKG_DEFAULT_TRIPLET\bin" -Filter *.dll | Copy-Item -Destination $runtime -Force -ErrorAction SilentlyContinue

          Copy-Item assets\tessdata\eng.traineddata $runtime\tessdata -Force

      - name: Create Inno Setup script
        shell: pwsh
        run: |
          New-Item packaging -ItemType Directory -Force | Out-Null

          @"
#define AppName "Tesseract-OCR"
#define AppVersion "dev"
#define InstallDir "$env:INSTALL_DIR"

[Setup]
AppName={#AppName}
AppVersion={#AppVersion}
DefaultDirName={#InstallDir}
PrivilegesRequired=lowest
OutputDir=..\output
OutputBaseFilename=tesseract-installer
Compression=lzma2
SolidCompression=yes

[Files]
Source: "{#SourcePath}\..\dist_runtime\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs

[Code]
procedure AddPathUser(Path: string);
var
  S: string;
begin
  if RegQueryStringValue(HKCU, 'Environment', 'Path', S) then
    if Pos(LowerCase(Path), LowerCase(S)) = 0 then
      RegWriteStringValue(HKCU, 'Environment', 'Path', S + ';' + Path)
  else
    RegWriteStringValue(HKCU, 'Environment', 'Path', Path);
end;

procedure CurStepChanged(Step: TSetupStep);
begin
  if Step = ssPostInstall then
    AddPathUser(ExpandConstant('{app}'));
end;
"@ | Set-Content packaging\tesseract.iss -Encoding UTF8

      - name: Build installer
        shell: pwsh
        run: |
          iscc packaging\tesseract.iss

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: Tesseract Installer
          path: output\*.exe
