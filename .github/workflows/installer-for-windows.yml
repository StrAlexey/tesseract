# .github/workflows/installer-for-windows.yml
#
# Builds Tesseract (win64) on Windows runner and packages it into an Inno Setup installer.
# - Uses vcpkg in-repo (no paths outside repo)
# - Copies offline traineddata from repo: assets/tessdata/eng.traineddata
# - Installs to D:\Tesseract-OCR (no admin) and adds install dir to USER PATH
#
# Repo must contain: assets/tessdata/eng.traineddata

name: Cross build for Windows

on:
  workflow_dispatch:

jobs:
  build_and_package_win64:
    runs-on: windows-latest

    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_DEFAULT_TRIPLET: x64-windows
      INSTALL_DIR: D:\Tesseract-OCR

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Validate offline traineddata exists in repo
        shell: pwsh
        run: |
          $td = Join-Path $env:GITHUB_WORKSPACE "assets\tessdata\eng.traineddata"
          if (!(Test-Path $td)) {
            throw "Missing required file: $td. Commit assets/tessdata/eng.traineddata (do not download in CI)."
          }
          Get-Item $td | Format-List

      # -----------------------------
      # vcpkg (in-repo, not outside)
      # -----------------------------
      - name: Clone vcpkg into repo workspace (if not already present)
        shell: pwsh
        run: |
          if (!(Test-Path $env:VCPKG_ROOT)) {
            git clone --depth 1 https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          } else {
            Write-Host "vcpkg already exists at $env:VCPKG_ROOT"
          }

          $marker = Join-Path $env:VCPKG_ROOT ".vcpkg-root"
          if (!(Test-Path $marker)) {
            throw "vcpkg root marker not found: $marker. The cloned vcpkg folder is not a valid classic vcpkg instance."
          }

      - name: Bootstrap vcpkg
        shell: pwsh
        run: |
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics

      - name: Install build tools
        shell: pwsh
        run: |
          choco install -y cmake ninja innosetup
          & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath

      # ----------------------------------------
      # Install deps via vcpkg
      # ----------------------------------------
      - name: Install Tesseract dependencies (vcpkg)
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          & "$env:VCPKG_ROOT\vcpkg.exe" `
            --vcpkg-root "$env:VCPKG_ROOT" `
            --classic `
            install "leptonica:$env:VCPKG_DEFAULT_TRIPLET"

      # -----------------------------
      # Configure & build Tesseract
      # -----------------------------
      - name: Configure Tesseract (CMake)
        shell: pwsh
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build-win64"
          New-Item -ItemType Directory -Force -Path $buildDir | Out-Null

          $toolchain = Join-Path $env:VCPKG_ROOT "scripts\buildsystems\vcpkg.cmake"

          cmake -S . -B $buildDir -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DVCPKG_TARGET_TRIPLET="$env:VCPKG_DEFAULT_TRIPLET" `
            -DSW_BUILD=OFF `
            -DBUILD_TESTS=OFF `
            -DBUILD_TRAINING_TOOLS=OFF `
            -DBUILD_SHARED_LIBS=ON

      - name: Build target tesseract (x64 Release)
        shell: pwsh
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build-win64"
          cmake --build $buildDir --config Release --target tesseract

      # -----------------------------
      # Assemble runtime folder
      # -----------------------------
      - name: Assemble runtime folder (dist_runtime)
        shell: pwsh
        run: |
          $buildDir   = Join-Path $env:GITHUB_WORKSPACE "build-win64"
          $runtimeDir = Join-Path $env:GITHUB_WORKSPACE "dist_runtime"
          $tessdata   = Join-Path $runtimeDir "tessdata"

          Remove-Item -Recurse -Force $runtimeDir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $runtimeDir | Out-Null
          New-Item -ItemType Directory -Force -Path $tessdata   | Out-Null

          $exe = Get-ChildItem -Path $buildDir -Recurse -Filter "tesseract.exe" -File -ErrorAction SilentlyContinue |
            Where-Object { $_.FullName -notmatch '\\CMakeFiles\\' } |
            Select-Object -First 1

          if (-not $exe) {
            Write-Host "Listing build directory for debugging:"
            Get-ChildItem -Recurse -File $buildDir | Select-Object FullName | Out-Host
            throw "tesseract.exe not produced (could not find anywhere under $buildDir)."
          }

          Write-Host "Using tesseract.exe: $($exe.FullName)"
          Copy-Item $exe.FullName $runtimeDir -Force

          Get-ChildItem -Path $buildDir -Recurse -Filter *.dll -File |
            Where-Object { $_.FullName -notmatch '\\CMakeFiles\\' } |
            ForEach-Object {
              Copy-Item $_.FullName $runtimeDir -Force -ErrorAction SilentlyContinue
            }

          $vcpkgBin = Join-Path $env:VCPKG_ROOT "installed\$env:VCPKG_DEFAULT_TRIPLET\bin"
          if (Test-Path $vcpkgBin) {
            Get-ChildItem -Path $vcpkgBin -Filter *.dll -File |
              ForEach-Object {
                Copy-Item $_.FullName $runtimeDir -Force -ErrorAction SilentlyContinue
              }
          }

          $repoTessdata = Join-Path $env:GITHUB_WORKSPACE "tessdata"
          if (Test-Path $repoTessdata) {
            Copy-Item (Join-Path $repoTessdata "*") $tessdata -Recurse -Force -ErrorAction SilentlyContinue
          }

          Copy-Item (Join-Path $env:GITHUB_WORKSPACE "assets\tessdata\eng.traineddata") $tessdata -Force

          Write-Host "dist_runtime:"
          Get-ChildItem -Path $runtimeDir -Force | Format-Table Name, Length
          Write-Host "dist_runtime\tessdata:"
          Get-ChildItem -Path $tessdata -Force | Format-Table Name, Length

      - name: Upload runtime artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-runtime-win64
          path: dist_runtime

      # -----------------------------
      # Create Inno Setup installer
      # -----------------------------
      - name: Create Inno Setup script
        shell: pwsh
        run: |
          $packagingDir = Join-Path $env:GITHUB_WORKSPACE "packaging"
          New-Item -ItemType Directory -Force -Path $packagingDir | Out-Null

          $dateTag = (Get-Date).ToString("yyyyMMdd-HHmm")
          $issPath = Join-Path $packagingDir "tesseract.iss"

          @"
          ; Auto-generated by GitHub Actions
          #define AppName "Tesseract-OCR"
          #define AppVersion "$dateTag"
          #define InstallDir "$($env:INSTALL_DIR)"

          [Setup]
          AppId={{A55E3C41-79F5-4D35-9E52-0D6B1F3B0E3D}
          AppName={#AppName}
          AppVersion={#AppVersion}

          DefaultDirName={#InstallDir}
          DisableDirPage=yes
          DisableProgramGroupPage=yes

          PrivilegesRequired=lowest

          OutputDir=output
          OutputBaseFilename=tesseract-ocr-installer-{#AppVersion}-win64
          Compression=lzma2
          SolidCompression=yes
          WizardStyle=modern
          UninstallDisplayIcon={app}\tesseract.exe

          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Files]
          Source: "{#SourcePath}\..\dist_runtime\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs ignoreversion

          [Registry]
          Root: HKCU; Subkey: "Software\Tesseract-OCR"; ValueType: string; ValueName: "Path"; ValueData: "{app}"; Flags: uninsdeletekey

          [Code]
          const
            HWND_BROADCAST   = $FFFF;
            WM_SETTINGCHANGE = $001A;
            SMTO_ABORTIFHUNG = $0002;

          function SendMessageTimeout(hWnd: Longint; Msg: Longint; wParam: Longint; lParam: string;
            fuFlags: Longint; uTimeout: Longint; var lpdwResult: Longint): Longint;
            external 'SendMessageTimeoutW@user32.dll stdcall';

          procedure BroadcastEnvironmentChange;
          var
            ResultCode: Longint;
          begin
            ResultCode := 0;
            SendMessageTimeout(HWND_BROADCAST, WM_SETTINGCHANGE, 0, 'Environment', SMTO_ABORTIFHUNG, 5000, ResultCode);
          end;

          procedure EnvAddPathUser(const NewPath: string);
          var
            Paths: string;
          begin
            if RegQueryStringValue(HKCU, 'Environment', 'Path', Paths) then
            begin
              if Pos(LowerCase(NewPath), LowerCase(Paths)) = 0 then
                Paths := Paths + ';' + NewPath;
            end
            else
              Paths := NewPath;

            RegWriteStringValue(HKCU, 'Environment', 'Path', Paths);
            BroadcastEnvironmentChange;
          end;

          procedure EnvRemovePathUser(const RemovePath: string);
          var
            Paths, NewPaths: string;
            Parts: TArrayOfString;
            I: Integer;
          begin
            if not RegQueryStringValue(HKCU, 'Environment', 'Path', Paths) then
              exit;

            Parts := SplitString(Paths, ';');
            NewPaths := '';

            for I := 0 to GetArrayLength(Parts)-1 do
            begin
              if CompareText(Trim(Parts[I]), Trim(RemovePath)) <> 0 then
              begin
                if NewPaths = '' then
                  NewPaths := Parts[I]
                else
                  NewPaths := NewPaths + ';' + Parts[I];
              end;
            end;

            RegWriteStringValue(HKCU, 'Environment', 'Path', NewPaths);
            BroadcastEnvironmentChange;
          end;

          procedure CurStepChanged(CurStep: TSetupStep);
          begin
            if CurStep = ssPostInstall then
              EnvAddPathUser(ExpandConstant('{app}'));
          end;

          procedure CurUninstallStepChanged(CurUninstallStep: TUninstallStep);
          begin
            if CurUninstallStep = usPostUninstall then
              EnvRemovePathUser(ExpandConstant('{app}'));
          end;
          "@ | Set-Content -Encoding UTF8 $issPath

          Write-Host "Created: $issPath"
          Get-Content $issPath | Select-Object -First 120 | Out-Host

      - name: Build installer (Inno Setup)
        shell: pwsh
        run: |
          iscc "packaging\tesseract.iss"
          dir output

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: Tesseract Installer (Inno Setup, D drive)
          path: output\*.exe
