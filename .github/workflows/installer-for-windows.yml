name: Cross build for Windows

on:
  workflow_dispatch:

jobs:
  build_runtime_win64:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      # 1) Build Tesseract using existing script (UNCHANGED)
      - name: Build Tesseract (existing script)
        run: |
          set -e
          chmod +x nsis/build.sh
          nsis/build.sh x86_64

      # 2) Assemble runtime folder
      - name: Assemble runtime folder
        run: |
          set -euo pipefail

          RUNTIME_DIR="dist_runtime"
          MINGW_INSTALL_DIR="${PWD}/mingw64"

          if [ ! -d "$MINGW_INSTALL_DIR" ]; then
            echo "Missing $MINGW_INSTALL_DIR"
            exit 1
          fi

          rm -rf "$RUNTIME_DIR"
          mkdir -p "$RUNTIME_DIR/tessdata"

          # Main exe
          cp "$MINGW_INSTALL_DIR/bin/tesseract.exe" "$RUNTIME_DIR/"

          # DLLs
          cp "$MINGW_INSTALL_DIR/bin/"*.dll "$RUNTIME_DIR/" || true
          if [ -d "${PWD}/dll" ]; then
            cp -Lv "${PWD}/dll/"*.dll "$RUNTIME_DIR/" || true
          fi

          # tessdata support files
          if [ -d "$MINGW_INSTALL_DIR/share/tessdata" ]; then
            cp -R "$MINGW_INSTALL_DIR/share/tessdata/"* "$RUNTIME_DIR/tessdata/" || true
          fi

          # Remove all traineddata
          rm -f "$RUNTIME_DIR/tessdata/"*.traineddata || true

          # Copy YOUR traineddata from repo (offline, guaranteed)
          cp assets/tessdata/eng.traineddata "$RUNTIME_DIR/tessdata/"

          echo "Runtime contents:"
          ls -la "$RUNTIME_DIR"
          echo "tessdata:"
          ls -la "$RUNTIME_DIR/tessdata"

      - name: Upload runtime artifact
        uses: actions/upload-artifact@v6
        with:
          name: tesseract-runtime-win64
          path: dist_runtime

  package_inno_installer:
    runs-on: windows-latest
    needs: build_runtime_win64
    steps:
      - uses: actions/checkout@v6

      - name: Download runtime artifact
        uses: actions/download-artifact@v6
        with:
          name: tesseract-runtime-win64
          path: dist_runtime

      - name: Install Inno Setup
        shell: powershell
        run: |
          choco install innosetup -y

      - name: Create Inno Setup script
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "packaging" | Out-Null
          New-Item -ItemType Directory -Force -Path "output" | Out-Null

          $dateTag = (Get-Date).ToString("yyyyMMdd-HHmm")
          $issPath = "packaging\tesseract.iss"

          $lines = @(
            "; Auto-generated by GitHub Actions",
            "#define AppName ""Tesseract-OCR""",
            "#define AppVersion ""$dateTag""",
            "#define InstallDir ""D:\Tesseract-OCR""",
            "",
            "[Setup]",
            "AppId={{A55E3C41-79F5-4D35-9E52-0D6B1F3B0E3D}",
            "AppName={#AppName}",
            "AppVersion={#AppVersion}",
            "DefaultDirName={#InstallDir}",
            "DisableDirPage=yes",
            "DisableProgramGroupPage=yes",
            "PrivilegesRequired=lowest",
            "",
            "OutputDir=output",
            "OutputBaseFilename=tesseract-ocr-installer-{#AppVersion}-win64",
            "Compression=lzma2",
            "SolidCompression=yes",
            "WizardStyle=modern",
            "UninstallDisplayIcon={app}\tesseract.exe",
            "",
            "[Languages]",
            "Name: ""english""; MessagesFile: ""compiler:Default.isl""",
            "",
            "[Files]",
            "Source: ""{#SourcePath}\..\dist_runtime\*""; DestDir: ""{app}""; Flags: recursesubdirs createallsubdirs ignoreversion",
            "",
            "[Registry]",
            "Root: HKCU; Subkey: ""Software\Tesseract-OCR""; ValueType: string; ValueName: ""Path""; ValueData: ""{app}""; Flags: uninsdeletekey"
          )

          Set-Content -Path $issPath -Value $lines -Encoding UTF8
          Get-Content $issPath

      - name: Build installer
        shell: powershell
        run: |
          iscc "packaging\tesseract.iss"
          dir output

      - name: Upload installer
        uses: actions/upload-artifact@v6
        with:
          name: Tesseract Installer (Inno Setup, D drive)
          path: output\*.exe
